<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire Image + Signature</title>
  <style>canvas { border: 1px solid black; }</style>
</head>
<body>
  <h2>Formulaire avec image + signature</h2>
  <form id="myForm" action="https://script.google.com/macros/s/AKfycbzIkRd81r0ONEVmMDT45lm-dNE6Nl7lAbkKjpfYaKOLIPcuBpfuoSzqNndOhy-b29cO/exec" method="POST" target="hidden_iframe">
    <label>Nom : <input type="text" name="nom" required></label><br><br>
    <label>Email : <input type="email" name="email" required></label><br><br>
    <label>Photo : <input type="file" id="photoFile" accept="image/*" required></label><br><br>
    <label>Signature (dessin) :</label><br>
    <canvas id="signature-pad" width="300" height="150"></canvas><br>
    <button type="button" id="clear">Effacer la signature</button><br><br>

    <!-- Champs cachÃ©s pour envoyer base64 -->
    <textarea name="photoBase64" id="photoBase64" style="display:none;"></textarea>
    <textarea name="signatureBase64" id="signatureBase64" style="display:none;"></textarea>

    <button type="submit">Envoyer</button>
  </form>
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script>
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);
    document.getElementById('clear').onclick = () => signaturePad.clear();

    const photoInput = document.getElementById('photoFile');
    const photoBase64 = document.getElementById('photoBase64');
    const signatureBase64 = document.getElementById('signatureBase64');

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('myForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (signaturePad.isEmpty()) {
        alert("Veuillez signer !");
        return;
      }

      const photoFile = photoInput.files[0];
      if (!photoFile) {
        alert("Veuillez choisir une photo.");
        return;
      }

      try {
        // Convertir photo en base64
        const photoDataUrl = await fileToBase64(photoFile);
        photoBase64.value = photoDataUrl;

        // Convertir signature canvas en base64
        signatureBase64.value = signaturePad.toDataURL();

        // Envoyer le formulaire classique POST (avec base64 dans textarea)
        e.target.submit();
      } catch (err) {
        alert("Erreur lors de la conversion des fichiers: " + err.message);
      }
    });
  </script>
</body>
</html>
